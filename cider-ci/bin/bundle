#!/bin/bash
set -eux

trap "{ remove-ruby; exit -1 }" ERR SIGTERM SIGINT

function rbenv-init {
  # remove the broken rehash plugin
  rm -rf ${HOME}/.rbenv/plugins/rbenv-gem-rehash
  export PATH=${HOME}/.rbenv/versions/${RBENV_VERSION}/bin:${HOME}/.rbenv/bin:$PATH
  eval "$(rbenv init -)"
}

function remove-ruby {
  rm -rf ${HOME}/.rbenv/versions/${RBENV_VERSION}
}

function remove-broken-rubies {
  if [ ! -f  ${HOME}/.rbenv/versions/${RBENV_VERSION}/bin/ruby ]; then
    remove-ruby
  fi
  if [ ! -f  ${HOME}/.rbenv/versions/${RBENV_VERSION}/bin/gem ]; then
    remove-ruby
  fi
}

function init-ruby-and-rbenv {
  if [ ! -d ${HOME}/.rbenv/versions/${RBENV_VERSION} ]; then
    curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
    rbenv-init
    rbenv install ${RBENV_VERSION}
  else
    rbenv-init
  fi
}

function install-bundler {
  if [ ! -f ${HOME}/.rbenv/versions/${RBENV_VERSION}/bin/bundle ]; then
    gem install bundler
  fi
}

remove-broken-rubies
init-ruby-and-rbenv
rm -f .bundle/config
bundle
