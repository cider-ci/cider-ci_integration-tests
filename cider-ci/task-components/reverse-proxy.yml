traits:
  Apache 2: true

trial_attachments:
  reverse-proxy-config:
    include_match: 'integration-tests\/reverse-proxy\/conf/.+\.conf$'
    content_type: text/plain

templates:
  reverse-proxy:
    src: integration-tests/cider-ci/templates/httpd.conf
    dest: integration-tests/reverse-proxy/conf/httpd.conf

scripts:

  reverse-proxy-run:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      cd ${INTEGRATION_TESTS_DIR}
      LD_LIBRARY_PATH=/usr/lib/apache2/modules/ /usr/sbin/apache2 -d reverse-proxy/ -f conf/httpd.conf -e info -DFOREGROUND

  test:
    start_when:
      the reverse proxy is running:
        script_key: reverse-proxy-run
        states: [executing]


  reverse-proxy-shutdown:
    timeout: 3 Seconds
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      kill -INT $(lsof -t -wni tcp:${CIDER_CI_TEST_RV_HTTP_PORT})
      sleep 1
    start_when:
      'test is in terminal state':
        script_key: test
        states: [aborted, defective, passed, failed, skipped]
      'reverse proxy is running':
        script_key: reverse-proxy-run
        states: [executing]
