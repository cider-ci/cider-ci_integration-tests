### run services ##############################################################


### common ####################################################################

services-down:
  body: echo "down"
  start-when:
    - script: run-api
      states: [aborted, passed, failed, skipped]
    - script: run-builder
      states: [aborted, passed, failed, skipped]
    - script: run-dispatcher
      states: [aborted, passed, failed, skipped]
    - script: run-notifier
      states: [aborted, passed, failed, skipped]
    - script: run-repository
      states: [aborted, passed, failed, skipped]
    - script: run-storage
      states: [aborted, passed, failed, skipped]


### install required clojure libraries ########################################

install_lein-dev-plugin:
  exclusive-executor-resource: install_lein-dev-plugin
  body: integration-tests/cider-ci/bin/install_lein-dev-plugin.sh


### the api also serves as a template #########################################

compile-api: &compile-service
  exclusive-executor-resource: compile-api
  environment-variables:
    SERVICE_NAME: api
  body: integration-tests/cider-ci/bin/compile-service.sh
  start-when:
    - script: install_lein-dev-plugin
  terminate-when:
    - script: test
      states: [aborted, passed, failed, skipped]

run-api: &run-service-default
  environment-variables:
    SERVICE_NAME: api
  body: |
    set -eux
    cd ${SERVICE_NAME}
    export CLASSPATH="../config:target/${SERVICE_NAME}.jar"
    java "cider_ci.${SERVICE_NAME}.main"

  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-api
    - script: configure
  terminate-when:
    - script: api-shutdown
      states: [aborted, passed, failed, skipped]

api-is-running: &is-running-default
  timeout: 210
  environment-variables:
    STATUS_URL: http://localhost:{{API_HTTP_PORT}}/cider-ci/api/status
  body: |
    #!/usr/bin/env bash
    set -eux
    until curl --silent --fail --user test-check-is-running:${SERVICES_SECRET} -I  "${STATUS_URL}";  do
      sleep 1;
    done
  start-when:
    - script: run-api
      states: [executing]
  terminate-when:
    - script: test
      states: [aborted, passed, failed, skipped]

api-shutdown: &shutdown-default
  timeout: 5
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{API_HTTP_PORT}}/cider-ci/api/shutdown
  body: |
    set -eux
    curl -X POST --silent --user shutdown:${SERVICES_SECRET} -I "${SHUTDOWN_URL}"
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]


### builder ###################################################################

compile-builder:
  <<: *compile-service
  exclusive-executor-resource: compile-builder
  environment-variables:
    SERVICE_NAME: builder
  body: integration-tests/cider-ci/bin/compile-service.sh

run-builder:
  <<: *run-service-default
  environment-variables:
    SERVICE_NAME: builder
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-builder
  terminate-when:
    - script: builder-shutdown
      states: [aborted, passed, failed, skipped]

builder-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{BUILDER_HTTP_PORT}}/cider-ci/builder/status
  start-when:
  - script: run-builder
    states: [executing]
  <<: *is-running-default

builder-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{BUILDER_HTTP_PORT}}/cider-ci/builder/shutdown


### dispatcher ################################################################

compile-dispatcher:
  <<: *compile-service
  exclusive-executor-resource: compile-dispatcher
  environment-variables:
    SERVICE_NAME: dispatcher
  body: integration-tests/cider-ci/bin/compile-service.sh

run-dispatcher:
  <<: *run-service-default
  environment-variables:
    SERVICE_NAME: dispatcher
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-dispatcher
  terminate-when:
    - script: dispatcher-shutdown
      states: [aborted, passed, failed, skipped]


dispatcher-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{DISPATCHER_HTTP_PORT}}/cider-ci/dispatcher/status
  start-when:
  - script: run-dispatcher
    states: [executing]
  <<: *is-running-default

dispatcher-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{DISPATCHER_HTTP_PORT}}/cider-ci/dispatcher/shutdown

### notifier ################################################################

compile-notifier:
  <<: *compile-service
  exclusive-executor-resource: compile-notifier
  environment-variables:
    SERVICE_NAME: notifier
  body: integration-tests/cider-ci/bin/compile-service.sh

run-notifier:
  <<: *run-service-default
  environment-variables:
    SERVICE_NAME: notifier
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-notifier
  terminate-when:
    - script: notifier-shutdown
      states: [aborted, passed, failed, skipped]


notifier-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{NOTIFIER_HTTP_PORT}}/cider-ci/notifier/status
  start-when:
  - script: run-notifier
    states: [executing]
  <<: *is-running-default

notifier-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{NOTIFIER_HTTP_PORT}}/cider-ci/notifier/shutdown


### repository ################################################################

compile-repository:
  <<: *compile-service
  exclusive-executor-resource: compile-repository
  environment-variables:
    SERVICE_NAME: repository
  body: integration-tests/cider-ci/bin/compile-service.sh

run-repository:
  <<: *run-service-default
  environment-variables:
    SERVICE_NAME: repository
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-repository
  terminate-when:
    - script: repository-shutdown
      states: [aborted, passed, failed, skipped]

repository-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{REPOSITORY_HTTP_PORT}}/cider-ci/repositories/status
  start-when:
  - script: run-repository
    states: [executing]
  <<: *is-running-default

repository-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{REPOSITORY_HTTP_PORT}}/cider-ci/repositories/shutdown


### storage ###################################################################

compile-storage:
  <<: *compile-service
  exclusive-executor-resource: compile-storage
  environment-variables:
    SERVICE_NAME: storage
  body: integration-tests/cider-ci/bin/compile-service.sh

run-storage:
  <<: *run-service-default
  environment-variables:
    SERVICE_NAME: storage
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-storage
  terminate-when:
    - script: storage-shutdown
      states: [aborted, passed, failed, skipped]

storage-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{STORAGE_HTTP_PORT}}/cider-ci/storage/status
  start-when:
  - script: run-storage
    states: [executing]
  <<: *is-running-default

storage-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{STORAGE_HTTP_PORT}}/cider-ci/storage/shutdown
