### run services ##############################################################

### common ####################################################################

services-down:
  body: echo "down"
  start-when:
    - script: run-api
      states: [aborted, passed, failed, skipped]
    - script: run-builder
      states: [aborted, passed, failed, skipped]
    - script: run-dispatcher
      states: [aborted, passed, failed, skipped]
    - script: run-repository
      states: [aborted, passed, failed, skipped]
    - script: run-storage
      states: [aborted, passed, failed, skipped]


### the api also servers as a template ########################################

compile-api: &compile-service
  exclusive-executor-resource: compile-api
  environment-variables:
    SERVICE_DIRECTORY: api
  body: integration-tests/cider-ci/bin/compile-service.sh
  terminate-when:
    - script: test
      states: [aborted, passed, failed, skipped]

run-api: &run-service-default
  environment-variables:
    SERVICE_DIRECTORY: api
  body: |
    set -eux
    cd ${SERVICE_DIRECTORY}
    lein trampoline run
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-api
  terminate-when:
    - script: api-shutdown
      states: [aborted, passed, failed, skipped]

api-is-running: &is-running-default
  timeout: 60
  environment-variables:
    STATUS_URL: http://localhost:{{API_HTTP_PORT}}/cider-ci/api/status
  body: |
    #!/usr/bin/env bash
    set -eux
    until curl --silent --fail --user x:secret -I  "${STATUS_URL}";  do
      sleep 1;
    done
  start-when:
    - script: run-api
      states: [executing]
  terminate-when:
    - script: test
      states: [aborted, passed, failed, skipped]

api-shutdown: &shutdown-default
  timeout: 5
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{API_HTTP_PORT}}/cider-ci/api/shutdown
  body: |
    set -eux
    curl -X POST --silent --user x:secret -I "${SHUTDOWN_URL}"
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]


### builder ###################################################################

compile-builder:
  <<: *compile-service
  exclusive-executor-resource: compile-builder
  environment-variables:
    SERVICE_DIRECTORY: builder
  body: integration-tests/cider-ci/bin/compile-service.sh

run-builder:
  <<: *run-service-default
  environment-variables:
    SERVICE_DIRECTORY: builder
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-builder

builder-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{BUILDER_HTTP_PORT}}/cider-ci/builder/status
  start-when:
  - script: run-builder
    states: [executing]
  <<: *is-running-default

builder-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{BUILDER_HTTP_PORT}}/cider-ci/builder/shutdown


### dispatcher ################################################################

compile-dispatcher:
  <<: *compile-service
  exclusive-executor-resource: compile-dispatcher
  environment-variables:
    SERVICE_DIRECTORY: dispatcher
  body: integration-tests/cider-ci/bin/compile-service.sh

run-dispatcher:
  <<: *run-service-default
  environment-variables:
    SERVICE_DIRECTORY: dispatcher
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-dispatcher

dispatcher-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{DISPATCHER_HTTP_PORT}}/cider-ci/dispatcher/status
  start-when:
  - script: run-dispatcher
    states: [executing]
  <<: *is-running-default

dispatcher-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{DISPATCHER_HTTP_PORT}}/cider-ci/dispatcher/shutdown


### repository ################################################################

compile-repository:
  <<: *compile-service
  exclusive-executor-resource: compile-repository
  environment-variables:
    SERVICE_DIRECTORY: repository
  body: integration-tests/cider-ci/bin/compile-service.sh

run-repository:
  <<: *run-service-default
  environment-variables:
    SERVICE_DIRECTORY: repository
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-repository

repository-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{REPOSITORY_HTTP_PORT}}/cider-ci/repositories/status
  start-when:
  - script: run-repository
    states: [executing]
  <<: *is-running-default

repository-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{REPOSITORY_HTTP_PORT}}/cider-ci/repositories/shutdown


### storage ###################################################################

compile-storage:
  <<: *compile-service
  exclusive-executor-resource: compile-storage
  environment-variables:
    SERVICE_DIRECTORY: storage
  body: integration-tests/cider-ci/bin/compile-service.sh

run-storage:
  <<: *run-service-default
  environment-variables:
    SERVICE_DIRECTORY: storage
  start-when:
    - script: create-database
    - script: create-rabbitmq-vhost
    - script: compile-storage

storage-is-running:
  environment-variables:
    STATUS_URL: http://localhost:{{STORAGE_HTTP_PORT}}/cider-ci/storage/status
  start-when:
  - script: run-storage
    states: [executing]
  <<: *is-running-default

storage-shutdown:
  <<: *shutdown-default
  environment-variables:
    SHUTDOWN_URL: http://localhost:{{STORAGE_HTTP_PORT}}/cider-ci/storage/shutdown
