### test ##################################################

# the demo repo must not reference objects
repack-demo-repo:
  body: cd demo-project-bash && git repack -a


bundle:
  exclusive-executor-resource: bundler
  body: cd integration-tests && bundle

test:
  timeout: 120
  body: |
    #!/usr/bin/env bash
    set -eux
    cd integration-tests
    bundle exec rspec $CIDER_CI_TASK_FILE
  start-when:
  - script: api-is-running
  - script: builder-is-running
  - script: bundle
  - script: dispatcher-is-running
  - script: executor-is-running
  - script: github-api-mock_is-serving
  - script: repack-demo-repo
  - script: repository-is-running
  - script: run-reverse-proxy
    states: ['executing']
  - script: start-xvnc
  - script: storage-is-running
  - script: ui-is-running

