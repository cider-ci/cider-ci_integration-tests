run_github-api-mock:
  timeout: 300
  body: |
    #!/usr/bin/env bash
    set -eux
    cd integration-tests
    bundle exec ruby github_api_mock.rb -p ${GITHUB_API_MOCK_PORT}
  start-when:
    - script: bundle
  terminate-when:
    - script: shutdown_github-api-mock
      states: [aborted, passed, failed, skipped]

shutdown_github-api-mock:
  timeout: 5
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${GITHUB_API_MOCK_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]
