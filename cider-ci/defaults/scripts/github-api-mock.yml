run_github-api-mock:
  timeout: 300
  body: |
    #!/usr/bin/env bash
    set -eux
    cd integration-tests
    bundle exec ruby github_api_mock.rb -p ${GITHUB_API_MOCK_PORT}
  start-when:
    - script: bundle
  terminate-when:
    - script: shutdown_github-api-mock
      states: [aborted, passed, failed, skipped]

github-api-mock_is-serving:
  timeout: 30 seconds
  start-when:
    - script: run_github-api-mock
      states: [executing]
  body: |
    #!/usr/bin/env bash
    set -ux
    until curl --silent --fail -I "http://localhost:${GITHUB_API_MOCK_PORT}/status" ; do
      sleep 1;
    done


shutdown_github-api-mock:
  timeout: 5
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${GITHUB_API_MOCK_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]
