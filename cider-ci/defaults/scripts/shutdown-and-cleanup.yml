### shutdown & cleanup ####################################

# the shutdown-delay is meant for debugging
shutdown-delay:
  start-when:
  - script: test
    states: [aborted, passed, failed, skipped]
  body: |
    #!/usr/bin/env bash
    set -ex
    if [ ! -z ${SHUTDOWN_DELAY} ]; then
      sleep ${SHUTDOWN_DELAY}
    fi


shutdown:
  body: |
    #!/usr/bin/env bash
    set -eux
    curl -X POST --silent --user 35cff40c-b4f8-4ca3-9217-d49c9c35f375:90b796aca99df1a74b172f3adee6f170fff3ea4e -I http://localhost:${EXECUTOR_HTTP_PORT}/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${API_HTTP_PORT}/cider-ci/api/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${BUILDER_HTTP_PORT}/cider-ci/builder/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${DISPATCHER_HTTP_PORT}/cider-ci/dispatcher/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${REPOSITORY_HTTP_PORT}/cider-ci/repositories/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${STORAGE_HTTP_PORT}/cider-ci/storage/shutdown
    curl -X POST --silent --user x:secret -I  http://localhost:${REVERSE_PROXY_HTTP_PORT}/shutdown
    kill -INT $(lsof -t -wni tcp:${UI_HTTP_PORT})
    sleep 5
  start-when:
    - script: shutdown-delay
      states: [aborted, passed, failed, skipped]


delete-rabbitmq-vhost:
  body:
    #!/usr/bin/env bash
    set -eux
    curl -i -u "$RABBITMQ_USER:$RABBITMQ_PASSWORD" -H "content-type:application/json" \
      -XDELETE "http://localhost:${RABBITMQ_MANAGEMENT_PORT}/api/vhosts/cider-ci_test_${CIDER_CI_TRIAL_ID}"
  ignore-abort: true
  ignore-state: true
  start-when:
  - script: shutdown
    states: [aborted, passed, failed, skipped]

delete-database:
  body: |
    #!/usr/bin/env bash
    set -eux
    cd user-interface
    bundle exec rake db:pg:terminate_connections db:drop
  ignore-abort: true
  ignore-state: true
  start-when:
  - script: shutdown
    states: [aborted, passed, failed, skipped]

stop-vnc:
  body: |
    #!/usr/bin/env bash
    set -eux
    tightvncserver -kill "${DISPLAY}" -clean
  ignore-abort: true
  ignore-state: true
  start-when:
  - script: shutdown
    states: [aborted, passed, failed, skipped]


