### executor ##############################################

configure-executor:
  body: |
    #!/usr/bin/ruby
    require 'yaml'
    require 'openssl'

    config = YAML.load_file 'executor/resources/config_default.yml'
    config['http']['port']= Integer(ENV['EXECUTOR_HTTP_PORT'])
    config['http']['ssl-port']= Integer(ENV['EXECUTOR_HTTPS_PORT'])
    config['server_base_url']= ("http://localhost:" + ENV['REVERSE_PROXY_HTTP_PORT'])
    config['nrepl']['enabled']=true
    config['nrepl']['port']= Integer(ENV['EXECUTOR_NREPL_PORT'])
    config['max_load']= 2

    File.open('executor/config/config.yml','w') { |file| file.write config.to_yaml }
    File.open('executor/config/traits.yml','w') { |file| file.write ["Bash", "Git"].to_yaml }


compile-executor:
  exclusive-executor-resource: compile-executor
  environment-variables:
    SERVICE_NAME: executor
  body: integration-tests/cider-ci/bin/compile-service.sh
  start-when:
    - script: install_lein-dev-plugin
  terminate-when:
    - script: shutdown-executor
      states: [aborted, passed, failed, skipped]

run-executor:
  body: |
    #!/usr/bin/env bash
    set -eux
    cd executor
    java -jar "target/executor.jar"
  start-when:
    - script: configure-executor
    - script: compile-executor
  terminate-when:
    - script: shutdown-executor
      states: [aborted, passed, failed, skipped]

executor-is-running:
  timeout: 210
  body: |
    #!/usr/bin/env bash
    set -ux
    until curl --silent --fail --user check:fb305779d33334f6d68650c3024626e12d3872a6  -I http://localhost:${EXECUTOR_HTTP_PORT}/hello ; do
      sleep 1;
    done
  start-when:
    - script: run-executor
      states: [executing]
  terminate-when:
    - script: run-executor
      states: [aborted, failed, skipped]
    - script: compile-executor
      states: [aborted, failed, skipped]


shutdown-executor:
  body: |
    set -eux
    curl -X POST --silent --user ${EXECUTOR_ID}:${EXECUTOR_PASSWORD} -I http://localhost:${EXECUTOR_HTTP_PORT}/shutdown
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]
