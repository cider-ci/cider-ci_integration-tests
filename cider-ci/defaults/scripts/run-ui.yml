bundle-ui:
  exclusive-executor-resource: rbenv
  timeout: 20 Minutes
  body: |
    #!/bin/bash
    set -eux
    cd user-interface
    ${CIDER_CI_WORKING_DIR}/integration-tests/cider-ci/bin/bundle

run-ui:
  body: |
    set -eux
    export PATH=$(pwd)/user-interface/vendor/jruby/bin/:$PATH
    cd user-interface
    bundle exec rails s -p  ${UI_HTTP_PORT}
  start-when:
    - script: bundle-ui
    - script: create-database
    - script: create-rabbitmq-vhost
  terminate-when:
    - script: shutdown-ui
      states: [aborted, passed, failed, skipped]

ui-is-running:
  timeout: 210
  environment-variables:
    STATUS_URL: http://localhost:{{UI_HTTP_PORT}}/cider-ci/ui/public
  body: |
    #!/usr/bin/env bash
    set -eux
    until curl --silent --fail --user x:${SERVICES_SECRET} -I  "${STATUS_URL}";  do
      sleep 1;
    done
  start-when:
    - script: run-ui
      states: [executing]
  terminate-when:
    - script: test
      states: [aborted, passed, failed, skipped]

shutdown-ui:
  body: |
    kill -INT $(lsof -t -wni tcp:${UI_HTTP_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]
