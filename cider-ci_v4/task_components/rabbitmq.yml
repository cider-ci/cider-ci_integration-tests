traits:
  RabbitMQ: true
  curl: true

scripts:

  create-rabbitmq-vhost:
    body: |
      #!/usr/bin/env bash
      set -eux
      curl --fail --silent --include --user "$RABBITMQ_USER:$RABBITMQ_PASSWORD" \
        -H "content-type:application/json" \
        -XPUT "http://localhost:${RABBITMQ_MANAGEMENT_PORT}/api/vhosts/cider-ci_test_${CIDER_CI_TRIAL_ID}"
      curl --fail --silent --include --user "$RABBITMQ_USER:$RABBITMQ_PASSWORD" \
        -H "content-type:application/json" \
        -XPUT "http://localhost:${RABBITMQ_MANAGEMENT_PORT}/api/permissions/cider-ci_test_${CIDER_CI_TRIAL_ID}/${RABBITMQ_USER}" \
        -d '{"scope":"client","configure":".*","write":".*","read":".*"}'

  delete-rabbitmq-vhost:
    body:
      #!/usr/bin/env bash
      set -eux
      curl -i -u "$RABBITMQ_USER:$RABBITMQ_PASSWORD" -H "content-type:application/json" \
        -XDELETE "http://localhost:${RABBITMQ_MANAGEMENT_PORT}/api/vhosts/cider-ci_test_${CIDER_CI_TRIAL_ID}"
    ignore_abort: true
    ignore_state: true
    start_when:
      include: cider-ci_v4/shared/test_is_terminal.yml
      'vhost has been created':
        script_key: create-rabbitmq-vhost
        states: [aborted, passed, failed, skipped]
